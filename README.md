# Микросервис для работы с балансом пользователей

## Установка и запуск
- Склонировать репозиторий _```git clone https://github.com/maryusenkova/user-balance.git```_
- Перейти в папку _user-balance_
- Выполнить команду ```docker-compose up --build user-balance```
- _При первом запуске контейнер с сервисом может не подключиться к БД из-за таймаута, в таком случае необходимо запустить команду ```docker-compose up user-balance```_

Сервер будет доступен по адресу http://localhost:8080/.
***

## Методы
### 1. Пополнение баланса
Для пополнения баланса (и создания аккаунта при отсутствии) используется POST запрос по адресу ```localhost:8080/account/add```.

Тело запроса должно содержать id пользователя и сумму, на которую пополняется счет. Пример:
```json
{
  "id": 1,
  "amount": 100
}
```
Ответ содержит id пользователя и текущий баланс:
```json
{
  "id": 1,
  "balance": 200
}
```
Пример curl запроса:
```
curl -X POST -d "{\"id\":1, \"amount\":100}" http://localhost:8080/account/add
```
### 2. Получение баланса
Чтобы получить баланс пользователя необходимо сделать GET запрос с обязательным параметром id:
```
curl -X GET "http://localhost:8080/account/balance?id=1"
```
Так же как и при пополнении баланса ответ выглядит следующим образом:
```json
{
  "id": 1,
  "balance": 200
}
```
### 3. Резерв средств на отдельном счете
Для того, чтобы зарезервировать средства на отдельном счете нужно отправить POST запрос по адресу ```localhost:8080/reserve_money```, в теле которого будут указаны следующие данные: id пользователя, id заказа, id услуги и стоимость. 

_При инициализации БД в таблицу услуг заносятся две тестовые услуги с id 1 и 2_

Пример тела запроса:
```json
{
  "id": 1,
  "serviceId": 1,
  "orderId": 1234,
  "amount":100
}
```
При успешном резервировании получим ответ с текущим балансом пользователя:
```json
{
  "id": 1,
  "balance": 100
}
```
Пример curl запроса:
```
curl -X POST -d "{\"id\":1, \"amount\":100, \"serviceId\":1, \"orderId\":1234}" http://localhost:8080/reserve_money
```
### 4. Признание выручки
Для признания выручки по резерву в теле POST запроса отправляется та же информация, что и для резерва по адресу ```localhost:8080/confirm_reserve```.  

Пример тела запроса:
```json
{
  "id": 1,
  "serviceId": 1,
  "orderId": 1234,
  "amount":100
}
```
При успешном признании выручки получим сообщение:
```json
{
  "success":"Money reserve confirmed"
}
```
Пример curl запроса:
```
curl -X POST -d "{\"id\":1, \"amount\":100, \"serviceId\":1, \"orderId\":12}" http://localhost:8080/confirm_reserve
```
### 5. Разрезервирование средств
Если не получилось применить услугу, можно разрезервировать деньги. Для этого в теле POST запроса отправляется та же информация, что и для резерва по адресу ```localhost:8080/abort_reserve```.  

Пример тела запроса:
```json
{
  "id": 1,
  "serviceId": 1,
  "orderId": 1234,
  "amount":100
}
```
При успешном разрезервировании получим сообщение:
```json
{
  "success":"Money reserve aborted"
}
```
Пример curl запроса:
```
curl -X POST -d "{\"id\":1, \"amount\":100, \"serviceId\":1, \"orderId\":1234}" http://localhost:8080/abort_reserve
```
### 6. Перевод денег от одного пользователя другому
Для перевода средств от одного пользователя другому используется POST запрос по адресу ```localhost:8080/account/transfer```.

Пример тела запроса:
```json
{
  "idFrom":1,
  "idTo": 2,
  "amount": 100
}
```
_Если у пользователя, который отправляет деньги еще нет счета, будет ошибка. Однако, если нет аккаунта у того, кому отправляют - он будет создан и деньги зачислены._

При успешном переводе получим сообщение
```json
{
  "success":"Transfer completed"
}
```
Пример curl запроса:
```
curl -X POST -d "{\"idFrom\":1, \"idTo\":2, \"amount\":100}" http://localhost:8080/account/transfer
```
### 7. Создание месячного отчета
Для создания месячного отчета в теле POST запроса указываются месяц и год, за который формируем отчет. Адрес: ```localhost:8080/get_report```.

Пример тела запроса:
```json
{
  "month": 11,
  "year": 2022
}
```
Ответ содержат ссылку на файл:
```json
{
  "file":"./csvreports/11_2022_report.csv"
}
```
Пример curl запроса:
```
curl -X POST -d "{\"month\":11, \"year\":2022}" http://localhost:8080/get_report
```
### 8. Получение истории операций
Для получения истории операций используется POST запрос по адресу ```localhost:8080/account/history```.

Тело запроса выглядит так:
```json
{
  "id": 1,
  "ordering": "date",
  "page": 1,
  "pageSize": 2
}
```
Здесь _"ordering"_ может принимать значения _date_, _-date_, _amount_, _-amount_. Префикс _"-"_ отвечает за направление сортировки, при его отсутствии она будет по возрастанию. Если название введено неверно, сортировка производится по amount.

Параметр _"page"_ отвечает за желаемую страницу, а _"pageSize"_ за количество записей на одной странице и является необязательным. По умолчанию размер страницы равен 3 записям.

В ответ возвращается массив с данными об истории успешных транзакций. Пример:
```json
[
  {
    "amount":100,
    "description":"Списание средств за услугу",
    "orderId":12,
    "service":"услуга 1",
    "closedDate":"2022-11-12T00:00:00Z"
  },{
    "amount":100,
    "description":"Пополнение счета",
    "orderId":0,
    "service":"n/d",
    "closedDate":"2022-11-13T00:00:00Z"
  }
]
```
Примеры curl запросов:
```
curl -X POST -d "{\"id\":1, \"ordering\":\"-date\", \"page\":1, \"pageSize\":10}" http://localhost:8080/account/history
```
```
curl -X POST -d "{\"id\":1, \"ordering\":\"-date\", \"page\":2}" http://localhost:8080/account/history
```

